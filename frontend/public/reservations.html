<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations - AirHost AI Pro</title>
    <meta name="description" content="Gesti√≥n profesional de reservas inspirado en Lodgify - AirHost AI">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="same-origin">
    <style>
        :root {
            --color-bg-primary: #0a0a0a;
            --color-bg-secondary: #111111;
            --color-bg-tertiary: #1a1a1a;
            --color-text-primary: #ffffff;
            --color-text-secondary: #b3b3b3;
            --color-text-tertiary: #666666;
            --color-accent: #00d084;
            --color-accent-hover: #00b572;
            --color-border: #2a2a2a;
            --color-hover: rgba(255, 255, 255, 0.05);
            --color-error: #ff4757;
            --color-warning: #ffa726;
            --color-success: #2ed573;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border);
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-accent);
            text-decoration: none;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 0.5rem;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 0.75rem 2rem;
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: var(--color-hover);
            color: var(--color-text-primary);
            border-right: 3px solid var(--color-accent);
        }

        .nav-menu .icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-select {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-primary);
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .reservations-table {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--color-bg-tertiary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-primary);
            border-bottom: 1px solid var(--color-border);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            vertical-align: top;
        }

        .table tbody tr:hover {
            background: var(--color-hover);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-confirmed {
            background: rgba(46, 213, 115, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .status-pending {
            background: rgba(255, 167, 38, 0.1);
            color: var(--color-warning);
            border: 1px solid rgba(255, 167, 38, 0.3);
        }

        .status-cancelled {
            background: rgba(255, 71, 87, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .status-completed {
            background: rgba(0, 208, 132, 0.1);
            color: var(--color-accent);
            border: 1px solid rgba(0, 208, 132, 0.3);
        }

        .guest-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .guest-name {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .guest-contact {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }

        .property-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .property-name {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .property-address {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }

        .dates-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .date-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .price-info {
            font-weight: 600;
            color: var(--color-accent);
            font-size: 1.1rem;
        }

        .nights-info {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-primary {
            background: var(--color-accent);
            color: white;
        }

        .btn-secondary {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem;
            gap: 1rem;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: var(--color-error);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* View Controls */
        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .view-controls {
            display: flex;
            background: var(--color-bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--color-border);
        }

        .view-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 6px;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .view-btn.active {
            background: var(--color-accent);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 208, 132, 0.2);
        }

        .view-btn:hover:not(.active) {
            background: var(--color-hover);
            color: var(--color-text-primary);
        }

        /* Calendar Styles */
        .calendar-container {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg-tertiary);
        }

        .calendar-nav-btn {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-primary);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-accent);
        }

        .calendar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .calendar-view-selector {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-view-btn {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-secondary);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .calendar-view-btn.active {
            background: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: var(--color-text-primary);
            background: var(--color-bg-tertiary);
            border-bottom: 1px solid var(--color-border);
        }

        .calendar-day {
            min-height: 120px;
            padding: 8px;
            border-right: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
            position: relative;
            background: var(--color-bg-primary);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.other-month {
            background: var(--color-bg-secondary);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: rgba(0, 208, 132, 0.1);
            border-color: var(--color-accent);
        }

        .day-number {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .calendar-day.today .day-number {
            color: var(--color-accent);
            font-weight: 600;
        }

        .reservation-event {
            background: var(--color-accent);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .reservation-event:hover {
            background: var(--color-accent-hover);
            transform: scale(1.02);
        }

        .reservation-event.status-pending {
            background: var(--color-warning);
        }

        .reservation-event.status-cancelled {
            background: var(--color-error);
        }

        .reservation-event.status-completed {
            background: var(--color-success);
        }

        .reservation-event.checkout {
            background: linear-gradient(45deg, var(--color-accent) 50%, var(--color-bg-tertiary) 50%);
            border: 1px solid var(--color-accent);
        }

        .more-events {
            font-size: 0.7rem;
            color: var(--color-text-tertiary);
            cursor: pointer;
            text-align: center;
            padding: 2px;
        }

        .more-events:hover {
            color: var(--color-accent);
        }

        /* Weekly view */
        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .week-day {
            min-height: 200px;
            padding: 12px;
            border-right: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
        }

        .week-day:last-child {
            border-right: none;
        }

        /* Daily view */
        .calendar-daily {
            padding: 2rem;
        }

        .daily-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .daily-date {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .daily-reservations {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .daily-reservation {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .daily-reservation:hover {
            background: var(--color-hover);
            border-color: var(--color-accent);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 100;
                padding: 1rem 0;
                height: auto;
                border-top: 1px solid var(--color-border);
                border-right: none;
            }
            
            .nav-menu {
                display: flex;
                justify-content: space-around;
                overflow-x: auto;
            }
            
            .nav-menu li {
                margin: 0;
                flex-shrink: 0;
            }
            
            .nav-menu a {
                flex-direction: column;
                padding: 0.5rem;
                text-align: center;
                font-size: 0.75rem;
            }
            
            .nav-menu .icon {
                margin: 0;
                margin-bottom: 0.25rem;
            }
            
            .main-content {
                padding-bottom: 100px;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .stats-summary {
                grid-template-columns: 1fr 1fr;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }

            .view-controls {
                align-self: center;
                margin-bottom: 1rem;
            }

            .filters {
                flex-direction: column;
                gap: 0.5rem;
            }

            .calendar-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .calendar-day {
                min-height: 80px;
            }

            .calendar-view-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">AirHost AI</a>
            </div>
            <ul class="nav-menu">
                <li><a href="/dashboard"><span class="icon">üìä</span> Dashboard</a></li>
                <li><a href="/properties"><span class="icon">üè†</span> Propiedades</a></li>
                <li><a href="/reservations" class="active"><span class="icon">üìÖ</span> Reservas</a></li>
                <li><a href="/channel-manager"><span class="icon">üì±</span> Channel Manager</a></li>
                <li><a href="/whatsapp-automation"><span class="icon">üí¨</span> WhatsApp</a></li>
                <li><a href="/smart-locks"><span class="icon">üîë</span> Smart Locks</a></li>
                <li><a href="/analytics"><span class="icon">üìà</span> Analytics</a></li>
                <li><a href="#" data-logout><span class="icon">üö™</span> Salir</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="header-title">Gesti√≥n de Reservas</h1>
            </div>

            <!-- Stats Summary -->
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="totalReservations">-</div>
                    <div class="stat-label">Total Reservas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeReservations">-</div>
                    <div class="stat-label">Activas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingReservations">-</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthlyRevenue">‚Ç¨-</div>
                    <div class="stat-label">Ingresos del Mes</div>
                </div>
            </div>

            <!-- View Controls and Filters -->
            <div class="controls-section">
                <div class="view-controls">
                    <button class="view-btn active" id="tableViewBtn" data-view="table">
                        <span class="icon">üìã</span>
                        <span>Tabla</span>
                    </button>
                    <button class="view-btn" id="calendarViewBtn" data-view="calendar">
                        <span class="icon">üìÖ</span>
                        <span>Calendario</span>
                    </button>
                </div>
                
                <div class="filters">
                    <select id="statusFilter" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="confirmed">Confirmadas</option>
                        <option value="pending">Pendientes</option>
                        <option value="cancelled">Canceladas</option>
                        <option value="completed">Completadas</option>
                    </select>
                    <select id="propertyFilter" class="filter-select">
                        <option value="">Todas las propiedades</option>
                    </select>
                </div>
            </div>

            <!-- Reservations Table -->
            <div id="reservationsContainer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span>Cargando reservas...</span>
                </div>
            </div>
        </main>
    </div>

    <script defer src="/js/api.js"></script>
    <script defer src="/js/auth.js"></script>
    <script>
        let reservations = [];
        let properties = [];
        let filteredReservations = [];
        let currentView = 'table';
        let calendarView = 'month';
        let currentDate = new Date();

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                const token = localStorage.getItem('airhost_token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                await Promise.all([
                    loadReservations(),
                    loadProperties()
                ]);

                setupFilters();
                setupViewControls();
            } catch (error) {
                console.error('Error initializing reservations page:', error);
                showError('Error cargando la p√°gina');
            }
        });

        // Load reservations from backend
        async function loadReservations() {
            try {
                const response = await window.AirHostAPI.getReservations();
                
                if (response.success && response.reservations) {
                    reservations = response.reservations;
                    filteredReservations = reservations;
                    updateStats();
                    renderReservations(filteredReservations);
                } else {
                    throw new Error(response.error || 'Error al cargar reservas');
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
                showError(`Error al cargar las reservas: ${error.message}`);
            }
        }

        // Load properties for filter
        async function loadProperties() {
            try {
                const response = await window.AirHostAPI.getProperties();
                
                if (response.success && response.properties) {
                    properties = response.properties;
                    populatePropertyFilter();
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const total = reservations.length;
            const active = reservations.filter(r => r.status === 'confirmed').length;
            const pending = reservations.filter(r => r.status === 'pending').length;
            
            // Calculate monthly revenue (current month)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyRevenue = reservations
                .filter(r => {
                    const checkIn = new Date(r.checkIn);
                    return checkIn.getMonth() === currentMonth && 
                           checkIn.getFullYear() === currentYear &&
                           r.status !== 'cancelled';
                })
                .reduce((sum, r) => sum + (r.totalAmount || 0), 0);

            document.getElementById('totalReservations').textContent = total;
            document.getElementById('activeReservations').textContent = active;
            document.getElementById('pendingReservations').textContent = pending;
            document.getElementById('monthlyRevenue').textContent = `‚Ç¨${monthlyRevenue.toLocaleString()}`;
        }

        // Populate property filter
        function populatePropertyFilter() {
            const select = document.getElementById('propertyFilter');
            select.innerHTML = '<option value="">Todas las propiedades</option>';
            
            properties.forEach(property => {
                const option = document.createElement('option');
                option.value = property.id;
                option.textContent = property.name;
                select.appendChild(option);
            });
        }

        // Setup filter event listeners
        function setupFilters() {
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('propertyFilter').addEventListener('change', applyFilters);
        }

        // Setup view control listeners
        function setupViewControls() {
            document.getElementById('tableViewBtn').addEventListener('click', () => switchView('table'));
            document.getElementById('calendarViewBtn').addEventListener('click', () => switchView('calendar'));
        }

        // Switch between table and calendar views
        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            document.getElementById('calendarViewBtn').classList.toggle('active', view === 'calendar');
            
            // Render appropriate view
            if (view === 'calendar') {
                renderCalendarView();
            } else {
                renderReservations(filteredReservations);
            }
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const propertyFilter = document.getElementById('propertyFilter').value;

            filteredReservations = reservations.filter(reservation => {
                const statusMatch = !statusFilter || reservation.status === statusFilter;
                const propertyMatch = !propertyFilter || reservation.propertyId === propertyFilter;
                
                return statusMatch && propertyMatch;
            });

            // Re-render current view
            if (currentView === 'calendar') {
                renderCalendarView();
            } else {
                renderReservations(filteredReservations);
            }
        }

        // Render calendar view
        function renderCalendarView() {
            const container = document.getElementById('reservationsContainer');
            
            const calendarHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div>
                            <button class="calendar-nav-btn" onclick="navigateCalendar(-1)">
                                ‚Äπ Anterior
                            </button>
                            <button class="calendar-nav-btn" onclick="navigateCalendar(1)">
                                Siguiente ‚Ä∫
                            </button>
                        </div>
                        
                        <h2 class="calendar-title" id="calendarTitle">
                            ${formatCalendarTitle()}
                        </h2>
                        
                        <div class="calendar-view-selector">
                            <button class="calendar-view-btn ${calendarView === 'month' ? 'active' : ''}" onclick="setCalendarView('month')">
                                Mes
                            </button>
                            <button class="calendar-view-btn ${calendarView === 'week' ? 'active' : ''}" onclick="setCalendarView('week')">
                                Semana
                            </button>
                            <button class="calendar-view-btn ${calendarView === 'day' ? 'active' : ''}" onclick="setCalendarView('day')">
                                D√≠a
                            </button>
                        </div>
                    </div>
                    
                    <div id="calendarContent">
                        ${renderCalendarContent()}
                    </div>
                </div>
            `;
            
            container.innerHTML = calendarHTML;
        }

        // Format calendar title based on view
        function formatCalendarTitle() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const day = currentDate.getDate();
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            switch (calendarView) {
                case 'month':
                    return `${monthNames[month]} ${year}`;
                case 'week':
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(day - currentDate.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    return `${weekStart.getDate()} - ${weekEnd.getDate()} ${monthNames[month]} ${year}`;
                case 'day':
                    return `${day} ${monthNames[month]} ${year}`;
                default:
                    return `${monthNames[month]} ${year}`;
            }
        }

        // Render calendar content based on view
        function renderCalendarContent() {
            switch (calendarView) {
                case 'month':
                    return renderMonthView();
                case 'week':
                    return renderWeekView();
                case 'day':
                    return renderDayView();
                default:
                    return renderMonthView();
            }
        }

        // Render month view
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(firstDay.getDate() - firstDay.getDay());
            
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const today = new Date();
            
            let html = '<div class="calendar-grid">';
            
            // Header days
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === today.toDateString();
                const dayReservations = getReservationsForDate(date);
                
                let dayClass = 'calendar-day';
                if (!isCurrentMonth) dayClass += ' other-month';
                if (isToday) dayClass += ' today';
                
                html += `<div class="${dayClass}">`;
                html += `<div class="day-number">${date.getDate()}</div>`;
                
                // Add reservation events
                const maxVisible = 3;
                dayReservations.slice(0, maxVisible).forEach(reservation => {
                    const eventClass = `reservation-event status-${reservation.status}`;
                    const isCheckout = date.toDateString() === new Date(reservation.checkOut).toDateString();
                    
                    html += `<div class="${eventClass} ${isCheckout ? 'checkout' : ''}" 
                                  onclick="viewReservation('${reservation.id}')" 
                                  title="${reservation.guestName || 'Sin nombre'} - ${reservation.property?.name || 'Propiedad'}">
                                ${reservation.guestName ? reservation.guestName.split(' ')[0] : 'Reserva'}
                             </div>`;
                });
                
                if (dayReservations.length > maxVisible) {
                    html += `<div class="more-events">+${dayReservations.length - maxVisible} m√°s</div>`;
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        // Render week view
        function renderWeekView() {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const today = new Date();
            
            let html = '<div class="calendar-grid">';
            
            // Header
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                html += `<div class="calendar-day-header">
                    ${dayNames[i]}<br>
                    <small>${date.getDate()}</small>
                </div>`;
            }
            
            // Week days
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const isToday = date.toDateString() === today.toDateString();
                const dayReservations = getReservationsForDate(date);
                
                let dayClass = 'week-day';
                if (isToday) dayClass += ' today';
                
                html += `<div class="${dayClass}">`;
                
                dayReservations.forEach(reservation => {
                    const eventClass = `reservation-event status-${reservation.status}`;
                    const isCheckout = date.toDateString() === new Date(reservation.checkOut).toDateString();
                    
                    html += `<div class="${eventClass} ${isCheckout ? 'checkout' : ''}" 
                                  onclick="viewReservation('${reservation.id}')" 
                                  title="${reservation.guestName || 'Sin nombre'} - ${reservation.property?.name || 'Propiedad'}">
                                ${reservation.guestName || 'Reserva'}<br>
                                <small>${reservation.property?.name || 'Propiedad'}</small>
                             </div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        // Render day view
        function renderDayView() {
            const dayReservations = getReservationsForDate(currentDate);
            
            let html = '<div class="calendar-daily">';
            
            if (dayReservations.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3 class="empty-state-title">No hay reservas este d√≠a</h3>
                        <p>No hay reservas programadas para esta fecha</p>
                    </div>
                `;
            } else {
                html += '<div class="daily-reservations">';
                
                dayReservations.forEach(reservation => {
                    const isCheckIn = currentDate.toDateString() === new Date(reservation.checkIn).toDateString();
                    const isCheckOut = currentDate.toDateString() === new Date(reservation.checkOut).toDateString();
                    
                    html += `
                        <div class="daily-reservation" onclick="viewReservation('${reservation.id}')">
                            <div class="guest-info">
                                <div class="guest-name">${reservation.guestName || 'Sin nombre'}</div>
                                <div class="guest-contact">${reservation.guestEmail || 'Sin email'}</div>
                            </div>
                            <div class="property-info">
                                <div class="property-name">${reservation.property?.name || 'Propiedad desconocida'}</div>
                                <div class="property-address">${reservation.property?.address || ''}</div>
                            </div>
                            <div class="dates-info">
                                ${isCheckIn ? '<div class="date-item">üì• Check-in hoy</div>' : ''}
                                ${isCheckOut ? '<div class="date-item">üì§ Check-out hoy</div>' : ''}
                                <div class="date-item">
                                    <span>üìÖ</span>
                                    <span>${formatDate(reservation.checkIn)} - ${formatDate(reservation.checkOut)}</span>
                                </div>
                            </div>
                            <div class="status-badge status-${reservation.status}">
                                ${getStatusText(reservation.status)}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        // Get reservations for a specific date
        function getReservationsForDate(date) {
            return filteredReservations.filter(reservation => {
                const checkIn = new Date(reservation.checkIn);
                const checkOut = new Date(reservation.checkOut);
                const targetDate = new Date(date);
                
                // Check if date is within reservation period (inclusive of check-in, exclusive of check-out)
                return targetDate >= checkIn && targetDate < checkOut;
            });
        }

        // Navigate calendar
        function navigateCalendar(direction) {
            switch (calendarView) {
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() + direction);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() + (direction * 7));
                    break;
                case 'day':
                    currentDate.setDate(currentDate.getDate() + direction);
                    break;
            }
            
            renderCalendarView();
        }

        // Set calendar view
        function setCalendarView(view) {
            calendarView = view;
            renderCalendarView();
        }

        // Render reservations table
        function renderReservations(reservations) {
            const container = document.getElementById('reservationsContainer');
            
            if (!reservations || reservations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3 class="empty-state-title">No hay reservas</h3>
                        <p>Las reservas aparecer√°n aqu√≠ cuando los hu√©spedes hagan reservas</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="reservations-table">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Hu√©sped</th>
                                    <th>Propiedad</th>
                                    <th>Fechas</th>
                                    <th>Estado</th>
                                    <th>Importe</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reservations.map(reservation => `
                                    <tr>
                                        <td>
                                            <div class="guest-info">
                                                <div class="guest-name">${reservation.guestName || 'Sin nombre'}</div>
                                                <div class="guest-contact">${reservation.guestEmail || 'Sin email'}</div>
                                                ${reservation.guestPhone ? `<div class="guest-contact">${reservation.guestPhone}</div>` : ''}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="property-info">
                                                <div class="property-name">${reservation.property?.name || 'Propiedad desconocida'}</div>
                                                <div class="property-address">${reservation.property?.address || ''}, ${reservation.property?.city || ''}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="dates-info">
                                                <div class="date-item">
                                                    <span>üìÖ</span>
                                                    <span>${formatDate(reservation.checkIn)} - ${formatDate(reservation.checkOut)}</span>
                                                </div>
                                                <div class="nights-info">
                                                    ${calculateNights(reservation.checkIn, reservation.checkOut)} noches
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge status-${reservation.status}">
                                                ${getStatusText(reservation.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="price-info">‚Ç¨${reservation.totalAmount?.toLocaleString() || 'N/A'}</div>
                                            <div class="nights-info">‚Ç¨${calculateNightlyRate(reservation.totalAmount, reservation.checkIn, reservation.checkOut)}/noche</div>
                                        </td>
                                        <td>
                                            <div class="actions">
                                                <button class="btn-small btn-primary" onclick="viewReservation('${reservation.id}')">
                                                    üëÅÔ∏è Ver
                                                </button>
                                                <button class="btn-small btn-secondary" onclick="editReservation('${reservation.id}')">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Helper functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function calculateNights(checkIn, checkOut) {
            const nights = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
            return Math.max(1, nights);
        }

        function calculateNightlyRate(totalAmount, checkIn, checkOut) {
            if (!totalAmount) return 'N/A';
            const nights = calculateNights(checkIn, checkOut);
            return Math.round(totalAmount / nights);
        }

        function getStatusText(status) {
            const statusMap = {
                'confirmed': 'Confirmada',
                'pending': 'Pendiente',
                'cancelled': 'Cancelada',
                'completed': 'Completada'
            };
            return statusMap[status] || status;
        }

        // Reservation actions
        function viewReservation(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);
            if (reservation) {
                const details = [
                    `üìÖ RESERVA: ${reservation.id}`,
                    `üë§ Hu√©sped: ${reservation.guestName || 'Sin nombre'}`,
                    `üìß Email: ${reservation.guestEmail || 'Sin email'}`,
                    `üìû Tel√©fono: ${reservation.guestPhone || 'Sin tel√©fono'}`,
                    `üè† Propiedad: ${reservation.property?.name || 'Desconocida'}`,
                    `üìç Direcci√≥n: ${reservation.property?.address || ''}, ${reservation.property?.city || ''}`,
                    `üìÖ Check-in: ${formatDate(reservation.checkIn)}`,
                    `üìÖ Check-out: ${formatDate(reservation.checkOut)}`,
                    `üåô Noches: ${calculateNights(reservation.checkIn, reservation.checkOut)}`,
                    `üí∞ Total: ‚Ç¨${reservation.totalAmount?.toLocaleString() || 'N/A'}`,
                    `üìä Estado: ${getStatusText(reservation.status)}`,
                    `üïê Creada: ${formatDate(reservation.createdAt)}`
                ].join('\n');
                
                alert(details);
            }
        }

        async function editReservation(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);
            if (!reservation) {
                alert('Reserva no encontrada');
                return;
            }

            // Create edit form
            const formHTML = `
                <div style="
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(0,0,0,0.8); 
                    z-index: 1000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    padding: 20px;
                " onclick="if(event.target === this) closeEditModal()">
                    <div style="
                        background: var(--color-bg-secondary); 
                        border: 1px solid var(--color-border); 
                        border-radius: 12px; 
                        padding: 2rem; 
                        max-width: 500px; 
                        width: 100%; 
                        max-height: 90vh; 
                        overflow-y: auto;
                    ">
                        <h3 style="color: var(--color-text-primary); margin-bottom: 1.5rem;">Editar Reserva</h3>
                        
                        <form id="editReservationForm" onsubmit="saveReservationChanges(event, '${reservationId}')">
                            <div style="margin-bottom: 1rem;">
                                <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Nombre del Hu√©sped:</label>
                                <input type="text" id="editGuestName" value="${reservation.guestName || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Email:</label>
                                <input type="email" id="editGuestEmail" value="${reservation.guestEmail || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Tel√©fono:</label>
                                <input type="tel" id="editGuestPhone" value="${reservation.guestPhone || ''}" 
                                       style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Check-in:</label>
                                    <input type="date" id="editCheckIn" value="${formatDateForInput(reservation.checkIn)}" 
                                           style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                                </div>
                                <div>
                                    <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Check-out:</label>
                                    <input type="date" id="editCheckOut" value="${formatDateForInput(reservation.checkOut)}" 
                                           style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Estado:</label>
                                    <select id="editStatus" 
                                            style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                                        <option value="confirmed" ${reservation.status === 'confirmed' ? 'selected' : ''}>Confirmada</option>
                                        <option value="pending" ${reservation.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                                        <option value="cancelled" ${reservation.status === 'cancelled' ? 'selected' : ''}>Cancelada</option>
                                        <option value="completed" ${reservation.status === 'completed' ? 'selected' : ''}>Completada</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Importe Total (‚Ç¨):</label>
                                    <input type="number" id="editTotalAmount" value="${reservation.totalAmount || ''}" step="0.01" 
                                           style="width: 100%; padding: 0.75rem; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-primary);">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button type="submit" class="btn-small btn-primary" style="flex: 1;">
                                    üíæ Guardar Cambios
                                </button>
                                <button type="button" onclick="cancelReservation('${reservationId}')" class="btn-small btn-danger">
                                    üóëÔ∏è Cancelar Reserva
                                </button>
                                <button type="button" onclick="closeEditModal()" class="btn-small btn-secondary">
                                    ‚ùå Cerrar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', formHTML);
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        function closeEditModal() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        async function saveReservationChanges(event, reservationId) {
            event.preventDefault();
            
            const formData = {
                guest: {
                    name: document.getElementById('editGuestName').value,
                    email: document.getElementById('editGuestEmail').value,
                    phone: document.getElementById('editGuestPhone').value
                },
                checkIn: document.getElementById('editCheckIn').value,
                checkOut: document.getElementById('editCheckOut').value,
                status: document.getElementById('editStatus').value,
                pricing: {
                    totalAmount: parseFloat(document.getElementById('editTotalAmount').value)
                }
            };

            try {
                const response = await window.AirHostAPI.updateReservation(reservationId, formData);
                
                if (response.success) {
                    alert('Reserva actualizada correctamente');
                    closeEditModal();
                    await loadReservations(); // Reload data
                } else {
                    alert('Error actualizando la reserva: ' + (response.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error updating reservation:', error);
                alert('Error actualizando la reserva: ' + error.message);
            }
        }

        async function cancelReservation(reservationId) {
            if (!confirm('¬øEst√°s seguro de que quieres cancelar esta reserva? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                const response = await window.AirHostAPI.cancelReservation(reservationId);
                
                if (response.success) {
                    alert('Reserva cancelada correctamente');
                    closeEditModal();
                    await loadReservations(); // Reload data
                } else {
                    alert('Error cancelando la reserva: ' + (response.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error canceling reservation:', error);
                alert('Error cancelando la reserva: ' + error.message);
            }
        }

        // Error handling
        function showError(message) {
            const container = document.getElementById('reservationsContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(errorDiv);
        }
    </script>
</body>
</html>